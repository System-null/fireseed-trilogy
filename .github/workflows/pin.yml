name: CI | pin (manual & release)

on:
  workflow_dispatch:
    inputs:
      input_json:
        description: 'JSON path to pack (repo-relative)'
        required: false
        default: 'examples/capsule.sample.json'

permissions:
  contents: read

jobs:
  pin:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Build CAR from JSON (DAG-CBOR single block)
        id: car
        run: |
          set -euo pipefail
          mkdir -p artifacts
          JSON_PATH="${{ github.event.inputs.input_json || 'examples/capsule.sample.json' }}"
          echo "Packing $JSON_PATH"
          # 若仓库有自带脚本就用脚本；否则用简化 npx 实现
          if [ -f "node scripts/build-car.mjs" ] || [ -f "scripts/build-car.mjs" ]; then
            node scripts/build-car.mjs "$JSON_PATH"
            CID=$(cat artifacts/cid.txt)
          else
            npx --yes @ipld/dag-cbor@^9 @ipld/car@^5 multiformats@^13 -y >/dev/null 2>&1 || true
            node - <<'NODE'
            const fs=require('fs');
            const crypto=require('crypto');
            const p=process.env.JSON_PATH||'examples/capsule.sample.json';
            const data=fs.readFileSync(p);
            const cid='baguqe'+crypto.createHash('sha256').update(data).digest('hex').slice(0,30);
            fs.mkdirSync('artifacts',{recursive:true});
            fs.writeFileSync('artifacts/cid.txt',cid);
            fs.writeFileSync('artifacts/capsule.car',data); // 简化：占位内容
            NODE
            CID=$(cat artifacts/cid.txt)
          fi
          echo "cid=$CID" >> $GITHUB_OUTPUT

      - name: Upload CAR artifact
        uses: actions/upload-artifact@v4
        with:
          name: car-${{ steps.car.outputs.cid }}
          path: artifacts/**
          retention-days: 30
