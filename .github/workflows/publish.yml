name: CI | publish (manual & release)

on:
  workflow_dispatch:
    inputs:
      input_json:
        description: "JSON path to pack (default: examples/capsule.sample.json)"
        required: false
        default: "examples/capsule.sample.json"
  release:
    types: [published]

permissions:
  contents: read

jobs:
  publish:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install build deps
        run: |
          npm i -D @ipld/dag-cbor@8.1.0 multiformats@12.1.3 @ipld/car@5.2.4 --no-audit --no-fund

      - name: Build CAR from JSON (DAG-CBOR single block)
        id: build
        run: |
          mkdir -p artifacts
          JSON_PATH="${{ github.event.inputs.input_json || 'examples/capsule.sample.json' }}"
          CID=$(node scripts/build-car.mjs "$JSON_PATH")
          echo "cid=$CID" >> $GITHUB_OUTPUT
          echo "Built CAR with CID: $CID"

      - name: Upload CAR artifact
        uses: actions/upload-artifact@v4
        with:
          name: fireseed-car
          path: artifacts/*.car

      # === Optional: web3.storage 上传并 Pin（配置了 token 才执行）===
      - name: Upload to web3.storage (optional)
        id: w3s
        if: ${{ secrets.WEB3_STORAGE_TOKEN != '' }}
        env:
          WEB3_STORAGE_TOKEN: ${{ secrets.WEB3_STORAGE_TOKEN }}
        run: |
          set -e
          CAR=$(ls artifacts/*.car | head -n1)
          # 直传 CAR；返回 JSON 含 cid
          curl -sS -X POST https://api.web3.storage/upload \
            -H "Authorization: Bearer $WEB3_STORAGE_TOKEN" \
            -H "Content-Type: application/car" \
            --data-binary "@${CAR}" > web3.json
          echo "cid=$(node -e \"console.log(JSON.parse(require('fs').readFileSync('web3.json','utf8')).cid)\")" >> $GITHUB_OUTPUT

      # === Optional: Pinata 复 Pin（有 JWT 才执行；若上一步拿到 CID 用其，否则用 build 输出）===
      - name: Pin to Pinata (optional)
        if: ${{ secrets.PINATA_JWT != '' }}
        env:
          PINATA_JWT: ${{ secrets.PINATA_JWT }}
        run: |
          set -e
          CID="${{ steps.w3s.outputs.cid || steps.build.outputs.cid }}"
          [ -n "$CID" ] || { echo "No CID to pin, skipping."; exit 0; }
          curl -sS -X POST https://api.pinata.cloud/pinning/pinByHash \
            -H "Authorization: Bearer $PINATA_JWT" \
            -H "Content-Type: application/json" \
            -d "{\"hashToPin\":\"$CID\",\"pinataOptions\":{\"cidVersion\":1}}" >/dev/null || true

      # === Optional: 网关探活（有 web3.storage 上传结果才做；失败不阻断）===
      - name: Gateway probe (optional)
        if: ${{ steps.w3s.outputs.cid != '' }}
        run: |
          CID="${{ steps.w3s.outputs.cid }}"
          curl -sSIf "https://w3s.link/ipfs/${CID}" || true
