name: CI | publish (manual)

on:
  workflow_dispatch:

permissions:
  contents: read

env:
  WEB3_TOKEN: ${{ secrets.WEB3_STORAGE_TOKEN }}
  PINATA_JWT: ${{ secrets.PINATA_JWT }}

jobs:
  publish:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v4

      - name: Check secrets
        id: chk
        run: |
          MISS=0
          [ -z "${WEB3_TOKEN}" ] && MISS=$((MISS+1))
          [ -z "${PINATA_JWT}" ] && MISS=$((MISS+1))
          if [ "$MISS" -eq 2 ]; then
            echo "No publishing secrets provided. Skipping."
            echo "skip=true" >> $GITHUB_OUTPUT
          fi

      - name: Upload to Web3.Storage (if token present)
        if: steps.chk.outputs.skip != 'true' && env.WEB3_TOKEN != ''
        run: |
          echo "Uploading sample sbom.json if exists..."
          test -f sbom.json || echo '{}' > sbom.json
          curl -sX POST -H "Authorization: Bearer ${WEB3_TOKEN}" \
            -H "Content-Type: application/json" \
            --data-binary @sbom.json https://api.web3.storage/upload || true

      - name: Upload to Pinata (if JWT present)
        if: steps.chk.outputs.skip != 'true' && env.PINATA_JWT != ''
        run: |
          echo "Uploading sample sbom.json to Pinata..."
          curl -sX POST https://api.pinata.cloud/pinning/pinFileToIPFS \
            -H "Authorization: Bearer ${PINATA_JWT}" \
            -F file=@sbom.json || true
