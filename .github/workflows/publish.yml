name: CI | publish (manual & release)

on:
  # 仅手动或正式发布触发，避免 push 分支时误触
  workflow_dispatch:
    inputs:
      input_json:
        description: 'JSON path to pack (default: examples/capsule.sample.json)'
        required: false
        default: 'examples/capsule.sample.json'
  release:
    types: [published]

permissions:
  contents: read

jobs:
  publish:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      # 只装构建 CAR 所需的最小依赖；不装项目依赖，避免 lockfile 分歧
      - name: Install build deps only
        run: |
          npm i -D @ipld/dag-cbor@8.0.1 multiformats@12.1.3 @ipld/car@5.2.4 --no-audit --no-fund

      - name: Build CAR from JSON
        id: build
        env:
          JSON_PATH: ${{ github.event.inputs.input_json || 'examples/capsule.sample.json' }}
        run: |
          mkdir -p artifacts
          # 你的脚本应已存在（scripts/build-car.mjs）；保持与仓库一致
          CID=$(node scripts/build-car.mjs "$JSON_PATH")
          echo "$CID" | tee artifacts/cid.txt
          echo "cid=$CID" >> "$GITHUB_OUTPUT"

      - name: Upload CAR artifacts
        uses: actions/upload-artifact@v4
        with:
          name: fireseed-car
          path: artifacts/
