name: CI | compliance

on:
  pull_request:
  workflow_dispatch:

permissions:
  contents: read
  security-events: write

jobs:
  compliance:
    runs-on: ubuntu-latest
    steps:
      - name: Disable core dumps
        run: |
          ulimit -S -c 0 || true

      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install
        run: npm ci

      - name: Generate SBOM (CycloneDX JSON)
        run: npx -y @cyclonedx/cyclonedx-npm@8.2.0 --output-file sbom.json

      - name: Assert SBOM exists & valid
        run: |
          test -s sbom.json
          npx -y @cyclonedx/cyclonedx-cli@0.27.0 validate --input-file sbom.json

      - name: OSV scan
        uses: google/osv-scanner-action@v1
        with:
          args: '--format=json --output=osv.json'

      - name: Fail on vulnerabilities
        run: |
          if [ -s osv.json ]; then
            echo "::error::OSV found vulnerabilities"
            exit 1
          fi

      - name: Dependency Review (diff only)
        if: ${{ github.event_name == 'pull_request' }}
        uses: actions/dependency-review-action@v4

      - uses: actions/upload-artifact@v4
        with:
          name: compliance-artifacts
          path: |
            sbom.json
            osv.json
