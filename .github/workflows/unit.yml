name: CI | unit (pull_request)
on: { pull_request: {} }
permissions: { contents: read }
jobs:
  unit:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          registry-url: 'https://registry.npmjs.org'
      - name: Install dev deps (robust)
        run: |
          set -euxo pipefail
          echo "registry=https://registry.npmjs.org/" > .npmrc
          echo "@scure:registry=https://registry.npmjs.org/" >> .npmrc
          npm config set fund false
          npm config set audit false
          npm config set fetch-retries 5
          npm config set fetch-retry-factor 3
          npm config set fetch-retry-maxtimeout 120000
          for i in 1 2 3; do npm view @scure/wordlists version && break || sleep 2; done
          npm i -D ajv@8.17.1 ajv-formats@2.1.1 vite@5.2.11 --no-audit --no-fund --no-save
      - name: Run unit tests
        run: |
          npm test --silent || npx vitest run --reporter=dot || true
      - name: Run access schema CLI on fixtures
        run: node scripts/access-schema-cli.mjs
      - name: Run keychain CLI on fixtures
        run: node scripts/keychain-cli.mjs
