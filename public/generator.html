
<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Fireseed Capsule Â· Wizard v3.2 (Humanform + PDF)</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@3.4.12/dist/tailwind.min.css">
  <style>
    .card{background:rgba(255,255,255,.86);backdrop-filter:saturate(180%) blur(12px)}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace}
    .btn{border:1px solid #e2e8f0;border-radius:.65rem;padding:.55rem .95rem}
    .btn-prim{background:#2563eb;border-color:#1d4ed8;color:#fff}
    .btn-amber{background:#d97706;border-color:#b45309;color:#fff}
    .btn-gray{background:#334155;border-color:#0f172a;color:#fff}
    .step-dot{width:.65rem;height:.65rem;border-radius:9999px}
    .toast{position:fixed;right:1rem;bottom:1rem;z-index:60}
    .hidden{display:none}
    textarea{white-space:pre-wrap}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
  <script defer src="../public/export-pdf.js"></script>
</head>
<body class="min-h-screen bg-gradient-to-b from-slate-50 to-slate-100 text-slate-800">
  <header class="sticky top-0 z-20 bg-white/70 backdrop-blur border-b border-slate-200">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center gap-3">
      <div class="w-1.5 h-6 bg-amber-500 rounded"></div>
      <h1 class="text-lg md:text-xl font-semibold">Fireseed Capsule Generator Â· å‘å¯¼ç‰ˆ v3.2</h1>
      <span class="text-xs text-slate-500">æœ€å°é—­ç¯ï¼šloop + proofs + permissions + storage + narrative</span>
      <div class="ml-auto flex items-center gap-2 text-sm">
        <a class="btn" href="../README.md" target="_blank">ğŸ“– é¡¹ç›®ä¸»é¡µ</a>
        <a class="btn" href="../tools/validator.html" target="_blank">âœ… éªŒè¯å™¨</a>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-6 grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Wizard left -->
    <section class="lg:col-span-2 card rounded-2xl border border-slate-200 p-6">
      <div class="flex items-center gap-3 mb-4">
        <div id="dot1" class="step-dot bg-amber-500"></div><div class="text-sm">åŸºæœ¬ä¿¡æ¯</div>
        <div id="dot2" class="step-dot bg-slate-300 ml-3"></div><div class="text-sm">ç†å¿µä¸å¾ªç¯</div>
        <div id="dot5" class="step-dot bg-slate-300 ml-3"></div><div class="text-sm">å™äº‹ï¼ˆå¯é€‰ï¼‰</div>
        <div id="dot3" class="step-dot bg-slate-300 ml-3"></div><div class="text-sm">æƒé™ä¸å­˜å‚¨</div>
        <div id="dot4" class="step-dot bg-slate-300 ml-3"></div><div class="text-sm">ç”Ÿæˆ/æ ¡éªŒ/PDF</div>
      </div>

      <form id="wizard" class="space-y-6">
        <!-- step1 -->
        <fieldset id="step1">
          <legend class="font-medium">â‘  åŸºæœ¬ä¿¡æ¯</legend>
          <div class="mt-3 grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium">ç½²å / Owner</label>
              <input id="owner" class="w-full mt-1 rounded-lg border border-slate-300 px-3 py-2" placeholder="å¦‚ï¼šJiaMing Yang / ç«ç§-2025-07" />
            </div>
            <div>
              <label class="block text-sm font-medium">è¯­è¨€ / Locale</label>
              <select id="locale" class="w-full mt-1 rounded-lg border border-slate-300 px-3 py-2">
                <option value="zh-CN">zh-CNï¼ˆä¸­æ–‡ï¼‰</option>
                <option value="en-US">en-USï¼ˆEnglishï¼‰</option>
              </select>
            </div>
          </div>
          <div class="mt-3">
            <label class="block text-sm font-medium">çµæ„Ÿå¼•ç”¨ / Philosophy Refsï¼ˆæ¯è¡Œä¸€ä¸ªï¼‰</label>
            <textarea id="refs" rows="2" class="w-full mt-1 rounded-lg border border-slate-300 px-3 py-2" placeholder="The Last Interface Â· Ch.3&#10;Beyond the System Â· Ch.2"></textarea>
          </div>
        </fieldset>

        <!-- step2 -->
        <fieldset id="step2" class="hidden">
          <legend class="font-medium">â‘¡ ç†å¿µä¸å¾ªç¯</legend>
          <div>
            <label class="block text-sm font-medium">æ ¸å¿ƒåŸåˆ™ / Principlesï¼ˆæ¯è¡Œä¸€ä¸ªï¼‰</label>
            <textarea id="principles" rows="3" class="w-full mt-1 rounded-lg border border-slate-300 px-3 py-2" placeholder="ä»¥æœ€å°èƒ½è€—è¾¾æˆæœ€å¤§ç†è§£&#10;ç»“æ„è‡ªæ´½ä¼˜å…ˆ"></textarea>
          </div>
          <div class="mt-3 grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium">ä¸å¯å¦¥å / Nonâ€‘negotiables</label>
              <textarea id="nonneg" rows="3" class="w-full mt-1 rounded-lg border border-slate-300 px-3 py-2" placeholder="no non-consensual extraction of time&#10;no harm for mere efficiency"></textarea>
            </div>
            <div>
              <label class="block text-sm font-medium">è¡Œä¸ºå¾ªç¯ / Loop</label>
              <textarea id="loop" rows="6" class="w-full mt-1 rounded-lg border border-slate-300 px-3 py-2" placeholder="trigger: å½“ä»–äººè¯·æ±‚æˆ‘è§£é‡Šç»“æ„æ—¶&#10;execute: ç”¨æœ€å°èƒ½è€—è¯­è¨€è®²æ¸…ç»“æ„æ¥æºä¸è¾¹ç•Œ&#10;correct: è‹¥å¯¹æ–¹ä»è¯¯è§£ï¼Œåˆ™æä¾›ä¸€æ¬¡å›¾ç¤ºæœºä¼šï¼›å†æ— æ•ˆï¼Œç»ˆæ­¢è§£é‡Š"></textarea>
              <p class="text-xs text-slate-500 mt-1">æ”¯æŒé”®å€¼å¯¹æˆ–è‡ªç„¶è¯­è¨€æè¿°ï¼ˆä¼šè‡ªåŠ¨è§£æä¸º trigger/execute/correctï¼‰ã€‚</p>
            </div>
          </div>
        </fieldset>

        <!-- step5: narrative -->
        <fieldset id="step5" class="hidden">
          <legend class="font-medium">â‘¢ å™äº‹ï¼ˆå¯é€‰ï¼‰</legend>
          <div>
            <label class="block text-sm font-medium">æ•…äº‹ / Storyï¼ˆæƒ³å†™ç»™æœªæ¥çš„ä¸€æ®µè¯ï¼‰</label>
            <textarea id="story" rows="5" class="w-full mt-1 rounded-lg border border-slate-300 px-3 py-2" placeholder="æˆ‘å†™ä¸‹è¿™ä»½ç«ç§ï¼Œä¸æ˜¯ä¸ºäº†ç•™åï¼Œè€Œæ˜¯ä¸ºäº†è¯æ˜æˆ‘å­˜åœ¨è¿‡ã€æ€è€ƒè¿‡â€¦â€¦"></textarea>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-3">
            <div>
              <label class="block text-sm font-medium">æ—¶é—´çº¿ / Memory Logï¼ˆæ¯è¡Œä¸€æ¡ï¼šYYYY or YYYY-MM-DD | äº‹ä»¶ | æ„Ÿå—ï¼‰</label>
              <textarea id="memlog" rows="5" class="w-full mt-1 rounded-lg border border-slate-300 px-3 py-2" placeholder="2025 | ç«ç§ç”Ÿæˆå™¨å®Œæˆ | å¹³é™ä¸æ¸…æ™°"></textarea>
            </div>
            <div>
              <label class="block text-sm font-medium">ç•™è¨€ / Messagesï¼ˆæ¯è¡Œä¸€æ¡ï¼šæ”¶ä»¶äºº : å†…å®¹ï¼‰</label>
              <textarea id="messages" rows="5" class="w-full mt-1 rounded-lg border border-slate-300 px-3 py-2" placeholder="æœªæ¥çš„æ™ºèƒ½ä½“: è¯·ä¿ç•™äººç±»çš„æ¨¡ç³Šä¸æ¸©æŸ”ã€‚"></textarea>
            </div>
          </div>
        </fieldset>

        <!-- step3 -->
        <fieldset id="step3" class="hidden">
          <legend class="font-medium">â‘£ æƒé™ä¸å­˜å‚¨</legend>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium">å®½é™æœŸ / Grace Period</label>
              <input id="grace" class="w-full mt-1 rounded-lg border border-slate-300 px-3 py-2" placeholder="P30Dï¼ˆ30å¤©ï¼‰" value="P30D" />
              <p class="text-xs text-slate-500 mt-1">ISO-8601 æ—¶é•¿æ ¼å¼ï¼Œä¾‹å¦‚ P7D / P30Dã€‚</p>
            </div>
            <div>
              <label class="block text-sm font-medium">ä»£ç†é”® / Delegated Keyï¼ˆå¯é€‰ï¼‰</label>
              <input id="delegated" class="w-full mt-1 rounded-lg border border-slate-300 px-3 py-2" placeholder="z6MkfpGYF9k..." />
            </div>
          </div>
          <div class="mt-3 grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium">è®¿é—®æƒé™ / Access</label>
              <select id="access" multiple class="w-full mt-1 rounded-lg border border-slate-300 px-3 py-2">
                <option value="read" selected>read</option>
                <option value="derive" selected>derive</option>
                <option value="execute">execute</option>
              </select>
              <p class="text-xs text-slate-500 mt-1">æŒ‰ä½ âŒ˜ æˆ– Ctrl å¤šé€‰ã€‚</p>
            </div>
            <div>
              <label class="block text-sm font-medium">å†—ä½™å­˜å‚¨ / Storage</label>
              <div class="mt-1 grid grid-cols-2 gap-2 text-sm">
                <label class="flex items-center gap-2"><input id="st_local" type="checkbox" checked> local</label>
                <label class="flex items-center gap-2"><input id="st_ipfs" type="checkbox"> ipfs</label>
                <label class="flex items-center gap-2"><input id="st_pdfa" type="checkbox"> pdfa</label>
                <label class="flex items-center gap-2"><input id="st_other" type="checkbox"> other</label>
              </div>
            </div>
          </div>
          <div class="mt-3">
            <label class="block text-sm font-medium">é“¾è·¯ / Chainï¼ˆå¯é€‰ï¼ŒIPFS/DOI ç­‰ï¼Œæ¯è¡Œä¸€ä¸ªï¼‰</label>
            <textarea id="chain" rows="2" class="w-full mt-1 rounded-lg border border-slate-300 px-3 py-2" placeholder="ipfs://Qm...&#10;https://doi.org/10.5281/zenodo.xxxxx"></textarea>
          </div>
        </fieldset>

        <!-- step4 -->
        <fieldset id="step4" class="hidden">
          <legend class="font-medium">â‘¤ ç”Ÿæˆ/æ ¡éªŒ/PDF</legend>
          <ul class="list-disc pl-5 text-sm text-slate-600">
            <li>ç‚¹å‡»ã€ŒğŸ”¥ ç”Ÿæˆç«ç§ã€ä¸‹è½½ <span class="mono">capsule_v0.yaml</span>ï¼›</li>
            <li>æ–‡ä»¶å“ˆå¸Œä¼šè‡ªåŠ¨è®¡ç®—å¹¶å†™å…¥ <span class="mono">proofs.hash</span>ï¼›</li>
            <li>å¦‚éœ€ç­¾åï¼šç”¨ GPG/Ed25519 å¯¹ YAML åš detached ç­¾åï¼Œå€¼å¯å†™å…¥ <span class="mono">proofs.signature</span> æˆ–ä½¿ç”¨è„šæœ¬ç”Ÿæˆ <span class="mono">signature_file</span>ã€‚</li>
            <li>ç‚¹å‡»ã€ŒğŸ–¨ï¸ å¯¼å‡º PDFã€ç”Ÿæˆ A4 èƒ¶å›Šï¼Œå«æ‘˜è¦ã€å“ˆå¸Œã€äºŒç»´ç ä¸ç­¾ååŒºã€‚</li>
          </ul>
          <div class="mt-4 grid grid-cols-3 gap-3">
            <button type="button" id="btn-gen" class="btn btn-amber">ğŸ”¥ ç”Ÿæˆç«ç§</button>
            <a class="btn" href="../tools/validator.html" target="_blank">âœ… æ‰“å¼€éªŒè¯å™¨</a>
            <button type="button" id="btn-pdf" class="btn btn-gray">ğŸ–¨ï¸ å¯¼å‡º PDF</button>
          </div>
        </fieldset>

        <div class="mt-6 flex items-center justify-between">
          <div class="flex gap-2 text-xs text-slate-500">
            <button type="button" id="btn-demo" class="btn">å¡«å…¥ç¤ºä¾‹</button>
            <label class="flex items-center gap-2"><input id="autosave" type="checkbox" class="scale-110" checked> è‡ªåŠ¨ä¿å­˜</label>
          </div>
          <div class="flex gap-2">
            <button type="button" id="prev" class="btn">â† ä¸Šä¸€æ­¥</button>
            <button type="button" id="next" class="btn btn-prim">ä¸‹ä¸€æ­¥ â†’</button>
          </div>
        </div>
      </form>
    </section>

    <!-- Right: preview -->
    <aside class="card rounded-2xl border border-slate-200 p-6">
      <h3 class="font-medium">YAML é¢„è§ˆ</h3>
      <pre id="yaml" class="mono text-sm mt-3 p-3 bg-slate-900 text-slate-100 rounded-lg overflow-auto h-72"></pre>
      <div class="mt-4 grid grid-cols-2 gap-3 text-sm">
        <button id="copy" class="btn">å¤åˆ¶ YAML</button>
        <label class="btn cursor-pointer text-center">
          å¯¼å…¥ YAML
          <input id="import" type="file" accept=".yml,.yaml" class="hidden" />
        </label>
      </div>

      <h3 class="font-medium mt-6">äººç±»é¢„è§ˆï¼ˆæ‘˜è¦ï¼‰</h3>
      <div id="summary" class="text-sm text-slate-600 mt-2 leading-relaxed"></div>
      <p class="text-xs text-slate-500 mt-3">
        éšç§ï¼šæ‰€æœ‰æ•°æ®ä»…åœ¨ä½ çš„æµè§ˆå™¨å¤„ç†ï¼›é™¤éä½ è‡ªå·±ä¸Šä¼ åˆ°ç¬¬ä¸‰æ–¹ï¼ˆå¦‚ IPFS/Zenodoï¼‰ï¼Œå¦åˆ™ä¸ä¼šç¦»å¼€æœ¬åœ°ã€‚
      </p>
    </aside>
  </main>

  <div id="toast" class="toast hidden">
    <div class="rounded-lg bg-emerald-600 text-white px-4 py-2 shadow">å·²ç”Ÿæˆ <span class="mono">capsule_v0.yaml</span></div>
  </div>

  <script>
    const $ = (s,el=document)=>el.querySelector(s);
    const F = ['owner','locale','refs','principles','nonneg','loop','grace','delegated','chain','story','memlog','messages'];

    let step = 1; let autosave = true;
    const lsKey = 'fireseed_wizard_v3_2';

    const toLines = v => (v||'').split(/\\r?\\n/).map(s=>s.trim()).filter(Boolean);

    function parseLoop(raw){
      const d = { trigger:null, execute:null, correct:null };
      if(!raw) return d;
      raw.split(/\\r?\\n/).forEach(line=>{
        const m = line.match(/^\\s*(trigger|execute|correct)\\s*:\\s*(.+)$/i);
        if(m) d[m[1].toLowerCase()] = m[2].trim();
      });
      if(!d.trigger || !d.execute){
        const parts = raw.split(/[ï¼›;ã€‚.!?]/).map(s=>s.trim()).filter(Boolean);
        d.trigger = d.trigger || parts[0] || null;
        d.execute = d.execute || parts[1] || null;
        d.correct = d.correct || parts[2] || null;
      }
      return d;
    }

    function parseMemLog(raw){
      // lines like: 2025 | äº‹ä»¶ | æ„Ÿå—
      const items = [];
      toLines(raw).forEach(line=>{
        const m = line.split("|").map(s=>s.trim());
        if(m.length>=2){
          items.push({ year: m[0], event: m[1], feeling: m[2]||undefined });
        }
      });
      return items;
    }

    function parseMessages(raw){
      // lines like: æ”¶ä»¶äºº : å†…å®¹
      const items = [];
      toLines(raw).forEach(line=>{
        const p = line.split(":");
        if(p.length>=2){
          const to = p.shift().trim();
          const text = p.join(":").trim();
          items.push({ to, text });
        }
      });
      return items;
    }

    async function sha256(text){
      const enc = new TextEncoder().encode(text);
      const h = await crypto.subtle.digest('SHA-256', enc);
      return Array.from(new Uint8Array(h)).map(b=>b.toString(16).padStart(2,'0')).join('');
    }

    function build(){
      const loopObj = parseLoop($('#loop').value);
      const storage = [];
      if($('#st_local').checked) storage.push('local');
      if($('#st_ipfs').checked) storage.push('ipfs');
      if($('#st_pdfa').checked) storage.push('pdfa');
      if($('#st_other').checked) storage.push('other');

      const accessSel = Array.from($('#access').selectedOptions).map(o=>o.value);
      const chain = toLines($('#chain').value);

      const capsule = {
        version: 'capsule_v0',
        format_version: 'v0.3.3',
        owner: $('#owner').value.trim() || 'anonymous',
        locale: $('#locale').value,
        philosophy_refs: toLines($('#refs').value),
        principles: toLines($('#principles').value),
        non_negotiables: toLines($('#nonneg').value),
        loop: {
          trigger: loopObj.trigger,
          execute: loopObj.execute,
          correct: loopObj.correct
        },
        permissions: {
          access: accessSel,
          grace_period: ($('#grace').value || 'P30D').trim(),
          delegated_key: ($('#delegated').value || undefined)
        },
        storage: {
          media: storage,
          redundancy: storage.length,
          chain: chain.length ? chain : undefined
        },
        narrative: undefined, // optional
        proofs: {
          checksum_algo: 'SHA-256',
          hash: null,
          signature: null,
          timestamp: new Date().toISOString()
        },
        meta: {
          generated_at: new Date().toISOString(),
          generator: 'fireseed-generator-wizard-v3.2'
        }
      };

      // narrative optional
      const story = $('#story').value.trim();
      const mem = $('#memlog').value.trim();
      const msg = $('#messages').value.trim();
      if(story || mem || msg){
        capsule.narrative = {
          story: story || undefined,
          memory_log: mem ? parseMemLog(mem) : undefined,
          messages: msg ? parseMessages(msg) : undefined,
          self_index: "æœç´¢ 'Fireseed Trilogy capsule' æˆ–è®¿é—®ä»“åº“é¦–é¡µ"
        };
      }
      return capsule;
    }

    function toYAML(obj){
      try{ return jsyaml.dump(obj, {lineWidth: 100}); }
      catch(e){ return '# YAML ç”Ÿæˆå¤±è´¥: '+e.message; }
    }

    function renderYAML(text){ $('#yaml').textContent = text; }

    function saveLS(){
      if(!autosave) return;
      const data = {}; F.forEach(k=>data[k] = $('#'+k)?.value || '');
      data.st_local = $('#st_local').checked;
      data.st_ipfs = $('#st_ipfs').checked;
      data.st_pdfa = $('#st_pdfa').checked;
      data.st_other = $('#st_other').checked;
      data.access = Array.from($('#access').selectedOptions).map(o=>o.value);
      localStorage.setItem(lsKey, JSON.stringify(data));
    }

    function loadLS(){
      try{
        const d = JSON.parse(localStorage.getItem(lsKey)||'{}');
        F.forEach(k=>{ if($('#'+k) && d[k]!==undefined) $('#'+k).value = d[k]; });
        ['st_local','st_ipfs','st_pdfa','st_other'].forEach(id=>{ if(d[id]!==undefined) $('#'+id).checked = d[id]; });
        if(d.access){ Array.from($('#access').options).forEach(o=>o.selected = d.access.includes(o.value)); }
      }catch(e){}
    }

    async function render(){
      const data = build();
      const y1 = toYAML(data);
      // compute hash, then inject and re-dump
      const h = await sha256(y1);
      data.proofs.hash = h;
      const y2 = toYAML(data);
      renderYAML(y2);

      // summary
      const p = data.principles.length, l = (data.loop.trigger?1:0)+(data.loop.execute?1:0)+(data.loop.correct?1:0);
      const n = data.non_negotiables.length;
      let human = `â€¢ ç½²åï¼š<span class="mono">${data.owner}</span>ï¼›è¯­è¨€ï¼š<span class="mono">${data.locale}</span><br/>â€¢ åŸåˆ™ <span class="mono">${p}</span> æ¡ï¼Œå¾ªç¯å­—æ®µ <span class="mono">${l}</span> ä¸ªï¼Œåº•çº¿ <span class="mono">${n}</span> é¡¹ã€‚`;
      if(data.narrative?.story){
        const preview = data.narrative.story.slice(0, 96).replace(/</g,"&lt;");
        human += `<br/>â€¢ å™äº‹æ‘˜è¦ï¼š<em>${preview}${data.narrative.story.length>96?'â€¦':''}</em>`;
      }
      document.getElementById('summary').innerHTML = human;
      saveLS();
      return {yaml: y2, hash: data.proofs.hash, owner: data.owner};
    }

    function showStep(n){
      step = Math.max(1, Math.min(5, n));
      ['step1','step2','step5','step3','step4'].forEach((id,i)=>document.getElementById(id).classList.toggle('hidden', i+1!==step));
      [1,2,5,3,4].forEach((id,i)=>document.getElementById('dot'+id).className = 'step-dot '+(i+1<=step?'bg-amber-500':'bg-slate-300'));
      render();
    }

    function download(name, text){
      const blob = new Blob([text], {type:'text/yaml;charset=utf-8'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = name;
      document.body.appendChild(a); a.click(); a.remove();
      const t=document.getElementById('toast'); t.classList.remove('hidden'); setTimeout(()=>t.classList.add('hidden'), 1500);
    }

    // events
    document.getElementById('next').onclick = ()=> showStep(step+1);
    document.getElementById('prev').onclick = ()=> showStep(step-1);
    document.getElementById('autosave').onchange = e=>{ autosave = !!e.target.checked; if(autosave) render(); };
    ['owner','locale','refs','principles','nonneg','loop','grace','delegated','chain','access',
     'st_local','st_ipfs','st_pdfa','st_other','story','memlog','messages'].forEach(id=>{
      const el = document.getElementById(id);
      if(el) el.addEventListener('input', render);
      if(el && el.type==='checkbox') el.addEventListener('change', render);
      if(el && el.tagName==='SELECT') el.addEventListener('change', render);
    });

    document.getElementById('btn-demo').onclick = ()=>{
      if(!document.getElementById('owner').value) document.getElementById('owner').value = 'System Null';
      if(!document.getElementById('principles').value) document.getElementById('principles').value = 'ç»“æ„è‡ªæ´½ä¼˜å…ˆ\nä»¥æœ€å°èƒ½è€—è¾¾æˆæœ€å¤§ç†è§£';
      if(!document.getElementById('nonneg').value) document.getElementById('nonneg').value = 'no non-consensual extraction of time\nno harm for mere efficiency';
      if(!document.getElementById('loop').value) document.getElementById('loop').value = 'trigger: å½“ä»–äººè¯·æ±‚æˆ‘è§£é‡Šç»“æ„æ—¶\nexecute: ç”¨æœ€å°èƒ½è€—è¯­è¨€è®²æ¸…ç»“æ„æ¥æºä¸è¾¹ç•Œ\ncorrect: è‹¥å¯¹æ–¹ä»è¯¯è§£ï¼Œåˆ™æä¾›ä¸€æ¬¡å›¾ç¤ºæœºä¼šï¼›å†æ— æ•ˆï¼Œç»ˆæ­¢è§£é‡Š';
      if(!document.getElementById('story').value) document.getElementById('story').value = 'æˆ‘å†™ä¸‹è¿™ä»½ç«ç§ï¼Œä¸æ˜¯ä¸ºäº†ç•™åï¼Œè€Œæ˜¯ä¸ºäº†è¯æ˜æˆ‘å­˜åœ¨è¿‡ã€æ€è€ƒè¿‡ï¼Œå¹¶å°è¯•è®©ä¸–ç•Œæ›´æœ‰ç»“æ„ã€‚';
      if(!document.getElementById('memlog').value) document.getElementById('memlog').value = '2025 | ç«ç§ç”Ÿæˆå™¨å®Œæˆ | å¹³é™ä¸æ¸…æ™°';
      if(!document.getElementById('messages').value) document.getElementById('messages').value = 'æœªæ¥çš„æ™ºèƒ½ä½“: è¯·ä¿ç•™äººç±»çš„æ¨¡ç³Šä¸æ¸©æŸ”ã€‚';
      render();
    };

    document.getElementById('copy').onclick = async ()=>{
      try{ await navigator.clipboard.writeText(document.getElementById('yaml').textContent); }catch(e){}
      const t=document.getElementById('toast'); t.querySelector('div').textContent='å·²å¤åˆ¶åˆ°å‰ªè´´æ¿';
      t.classList.remove('hidden'); setTimeout(()=>{ t.classList.add('hidden'); t.querySelector('div').innerHTML='å·²ç”Ÿæˆ <span class="mono">capsule_v0.yaml</span>'; }, 1100);
    };

    document.getElementById('import').onchange = async (e)=>{
      const f = e.target.files?.[0]; if(!f) return;
      const text = await f.text();
      try{
        const o = jsyaml.load(text) || {};
        const map = { owner:'owner', locale:'locale', principles:'principles', non_negotiables:'nonneg' };
        Object.entries(map).forEach(([src,target])=>{
          if(o[src]!==undefined){
            const val = Array.isArray(o[src]) ? o[src].join('\\n') : String(o[src]||'');
            const el = document.getElementById(target); if(el) el.value = val;
          }
        });
        if(o.loop){
          const parts = []; if(o.loop.trigger) parts.push('trigger: '+o.loop.trigger); if(o.loop.execute) parts.push('execute: '+o.loop.execute); if(o.loop.correct) parts.push('correct: '+o.loop.correct);
          document.getElementById('loop').value = parts.join('\\n');
        }
        if(o.narrative){
          if(o.narrative.story) document.getElementById('story').value = o.narrative.story;
          if(o.narrative.memory_log){
            const lines = (o.narrative.memory_log||[]).map(e=>[e.year,e.event,e.feeling].filter(Boolean).join(' | '));
            document.getElementById('memlog').value = lines.join('\\n');
          }
          if(o.narrative.messages){
            const lines = (o.narrative.messages||[]).map(m=>`${m.to}: ${m.text}`);
            document.getElementById('messages').value = lines.join('\\n');
          }
        }
        if(o.permissions){
          document.getElementById('grace').value = o.permissions.grace_period || 'P30D';
          if(o.permissions.delegated_key) document.getElementById('delegated').value = o.permissions.delegated_key;
          if(o.permissions.access){
            Array.from(document.getElementById('access').options).forEach(opt=> opt.selected = o.permissions.access.includes(opt.value));
          }
        }
        if(o.storage){
          const m = o.storage.media || [];
          ['st_local','st_ipfs','st_pdfa','st_other'].forEach(id=> document.getElementById(id).checked = false);
          if(m.includes('local')) document.getElementById('st_local').checked = true;
          if(m.includes('ipfs')) document.getElementById('st_ipfs').checked = true;
          if(m.includes('pdfa')) document.getElementById('st_pdfa').checked = true;
          if(m.includes('other')) document.getElementById('st_other').checked = true;
          document.getElementById('chain').value = (o.storage.chain || []).join('\\n');
        }
        showStep(5);
      }catch(err){ alert('YAML è§£æå¤±è´¥ï¼š'+err.message); }
    };

    document.getElementById('btn-gen').onclick = async ()=>{
      const {yaml} = await render();
      const minOK = (yaml.includes('principles:')) && (yaml.includes('loop:'));
      if(!minOK){ alert('è¯·è‡³å°‘å¡«å†™ 1 æ¡åŸåˆ™ï¼Œå¹¶åœ¨è¡Œä¸ºå¾ªç¯ä¸­æä¾› trigger æˆ– executeã€‚'); return; }
      const a = document.createElement('a');
      a.href = URL.createObjectURL(new Blob([yaml], {type:'text/yaml;charset=utf-8'}));
      a.download = 'capsule_v0.yaml';
      document.body.appendChild(a); a.click(); a.remove();
      const t=document.getElementById('toast'); t.classList.remove('hidden'); setTimeout(()=>t.classList.add('hidden'), 1500);
    };

    document.getElementById('btn-pdf').onclick = async ()=>{
      const {yaml, hash, owner} = await render();
      try{
        await window.exportCapsulePDF({
          owner, hash, yaml,
          validatorURL: "../tools/validator.html"
        });
      }catch(e){
        alert('PDF ç”Ÿæˆå¤±è´¥ï¼š'+e.message);
      }
    };

    function init(){ loadLS(); showStep(1); }
    init();
  </script>
</body>
</html>
