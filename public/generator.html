<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Fireseed Capsule Generator · 向导版 v3.6</title>
  <style>
    :root { --fg:#111; --muted:#666; --bg:#fafafa; --pri:#1f6feb; --bd:#e6e6e6; --hl:#fff6e8; --warn:#f44336; --ok:#2e7d32; }
    *{box-sizing:border-box} body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;color:var(--fg);background:var(--bg);margin:0}
    header{padding:28px 16px 8px; text-align:center}
    h1{margin:0 0 8px;font-size:22px}
    .sub{color:var(--muted);font-size:13px}
    .wrap{max-width:980px;margin:16px auto;padding:0 16px 64px;display:grid;grid-template-columns:1.2fr 1fr;gap:16px}
    .card{background:#fff;border:1px solid var(--bd);border-radius:14px;padding:16px;box-shadow:0 1px 0 rgba(0,0,0,.03)}
    label{display:block;font-size:13px;color:#444;margin:12px 0 6px}
    .lbl{display:flex;align-items:center;gap:6px}
    input,textarea,select{width:100%;padding:10px 12px;border:1px solid var(--bd);border-radius:10px;background:#fff;font-size:14px}
    textarea{min-height:92px;resize:vertical}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    button{cursor:pointer;border:1px solid var(--bd);background:#fff;border-radius:10px;padding:10px 14px;transition:.2s opacity,.2s background}
    button.loading{opacity:.7; position:relative}
    button.loading::after{content:'…';position:absolute;right:12px}
    .pri{background:var(--pri);color:#fff;border-color:var(--pri)}
    details{border:1px dashed var(--bd);border-radius:10px;padding:10px;margin-top:10px;background:#fcfcfc}
    summary{cursor:pointer;font-weight:600}
    pre{white-space:pre-wrap;border:1px solid var(--bd);padding:12px;border-radius:10px;background:#0d1117;color:#dfe2e7;font-size:12px;overflow:auto;max-height:60vh}
    .hint{font-size:12px;color:var(--muted)}
    footer{max-width:980px;margin:24px auto 64px;padding:0 16px;color:#777;font-size:12px}
    .badge{display:inline-block;background:#eef6ff;border:1px solid #c9e2ff;color:#0a3d90;font-size:12px;padding:2px 8px;border-radius:999px;margin:0 6px}
    .note{font-size:12px;color:#777;margin:4px 0 8px}
    .tooltip{border-bottom:1px dotted #999; cursor:help; position:relative; display:inline-block}
    .tooltip:hover::after{
      content: attr(data-tip);
      position:absolute; left:0; top:120%;
      min-width:180px; max-width:320px; padding:8px 10px;
      background: var(--hl); border:1px solid #f1d592; border-radius:6px;
      color:#4b4b4b; font-size:12px; line-height:1.4; z-index:10;
      box-shadow:0 2px 8px rgba(0,0,0,.06);
    }
    .muted{color:#666}
    .warn{color:var(--warn)}
    .ok{color:var(--ok)}
    .progress{height:6px;background:#f1f1f1;border-radius:6px;overflow:hidden;margin:8px 0 0}
    .progress>i{display:block;height:100%;background:linear-gradient(90deg,#5b9cff,#84c5ff);width:0%}
    .tiny{font-size:11px;color:#888}
    .flow{font-size:12px;color:#555;background:#fff;border:1px dashed #e6e6e6;border-radius:8px;padding:8px}
    .link{color:#1f6feb;text-decoration:none}
  </style>
</head>
<body>
  <header>
    <h1>Fireseed Capsule Generator · 向导版 v3.6 <span class="badge">纯前端 · 零后端 · 可离线</span></h1>
    <div class="sub">填完点“生成胶囊”即可下载 <code>capsule_v0.yaml</code>；或打开快照页打印为 PDF。</div>
  </header>

  <main class="wrap">
    <section class="card" id="form">
      <h3>基本信息</h3>
      <div class="row">
        <div>
          <label class="lbl">我是谁
            <span class="tooltip" data-tip="不管是谁打开这份说明书，都能认出那是我留下的声音。">❓</span>
          </label>
          <input id="owner" placeholder="例：李明 / Mia / 阿北" value="Lin Tao">
        </div>
        <div>
          <label class="lbl">我用的语言
            <span class="tooltip" data-tip="系统会用这个语言读懂我写的东西，也用同样的语言‘回信’。">❓</span>
          </label>
          <select id="locale">
            <option value="zh-CN">中文 🇨🇳</option>
            <option value="en-US">English 🇺🇸</option>
          </select>
        </div>
      </div>

      <label class="lbl">
        我思考时的“参考书”
        <span class="tooltip" data-tip="这些书、电影或人，曾经塑造了我的思考方式；未来有人想理解我，也该从这里开始。">❓</span>
      </label>
      <input id="philo" placeholder="例：深刻影响我价值观的书/理论/人物（论语、康德、妈妈的一句话）">

      <label class="lbl">我人生的三原则
        <span class="tooltip" data-tip="当我不在现场时，这三条会帮我‘自动做决定’，不走样。">❓</span>
      </label>
      <textarea id="principles" placeholder="例：①不撒谎 ②不伤人 ③不拖延（希望他人记住的核心品质）"></textarea>

      <label class="lbl">我行动的循环
        <span class="tooltip" data-tip="这是我习惯的节奏——遇事先感知，再判断，再行动，最后反思。">❓</span>
      </label>
      <textarea id="loop" placeholder="例：感知 → 判断 → 行动 → 反思"></textarea>

      <label class="lbl">我的底线
        <span class="tooltip" data-tip="这是我不会跨过去的线。哪怕一切都被优化到极致，也不能牺牲它。">❓</span>
      </label>
      <textarea id="nonn" placeholder="例：绝不为钱背叛朋友"></textarea>

      <label class="lbl">我想留下的话
        <span class="tooltip" data-tip="这是写给未来的留言。也许别人读到时，我已不在，但这些话依然能代表我。">❓</span>
      </label>
      <textarea id="narrative" placeholder="例：愿你在混乱中仍保持温柔与清晰。"></textarea>

      <details id="extraBox">
        <summary id="extraSummary">写更多 ▶</summary>
        <div class="note">这些内容<b>可写可不写</b>，不会影响生成结果。</div>
        <div class="row">
          <div>
            <label>📅 我铭记的日子</label>
            <input id="celebrations" placeholder="例如：生日 1990-01-01；纪念 2015-05-20">
          </div>
          <div>
            <label>👥 如果我不在了，请联系 <span class="warn">（重要）</span></label>
            <input id="emergency" placeholder="姓名: 李明, 邮箱: li@example.com / 微信: limom">
            <div class="tiny">请确保至少一位可靠联系人；这关系到 30/90 天异议期是否有效。</div>
          </div>
        </div>
        <div class="row">
          <div>
            <label>❤️ 我喜欢的事物（逗号分隔）</label>
            <input id="likes" placeholder="爵士乐, 书店, 夜空">
          </div>
          <div>
            <label>🙅 我讨厌的事物（逗号分隔）</label>
            <input id="dislikes" placeholder="噪音, 欺骗">
          </div>
        </div>
        <div class="row">
          <div>
            <label>📖 我愿意被读取的条件</label>
            <select id="access_terms">
              <option value="">未声明（默认遵循 permissions）</option>
              <option value="read_only">仅可阅读（别人只能看）</option>
              <option value="by_attribution">需署名引用（转载要标你名）</option>
              <option value="non_commercial">可用于非商业研究（不可卖）</option>
              <option value="custom">自定义条款…</option>
            </select>
            <input id="access_custom" placeholder="例如：仅限家人；或 CC BY-NC 4.0" style="display:none;margin-top:6px;">
            <div class="tiny">了解更多：<a class="link" href="../docs/ACCESS_TERMS.md" target="_blank" rel="noopener">常见条款说明</a></div>
          </div>
          <div>
            <label>🔑 更新密码（4~6位短语，可空）</label>
            <input id="passphrase" placeholder="seed42">
            <div class="tiny">此密码用于未来验证你对胶囊的修改权。未设置则不启用密码保护，可日后补设。</div>
          </div>
        </div>
        <div class="flow">生效流程：生成胶囊 → 发送受托人 → 选择 30/90 天异议期 → 期满生效</div>
      </details>

      <h3 style="margin-top:18px">权限与存储（已预设，若不懂可保持默认）</h3>
      <div class="row">
        <div>
          <label>是否允许派生（derive）</label>
          <select id="allow_derive"><option value="yes">是</option><option value="no">否</option></select>
        </div>
        <div>
          <label>异议期（grace_period）</label>
          <select id="grace"><option value="P30D">30 天</option><option value="P90D">90 天</option></select>
        </div>
      </div>
      <div class="progress"><i id="prog"></i></div>

      <div class="btns">
        <button class="pri" id="btnGen">生成胶囊</button>
        <button id="btnYAML">下载 YAML</button>
        <button id="btnPDF">导出 PDF</button>
        <button id="btnSnapshot">查看人类快照</button>
        <button id="btnClear" title="清除本地草稿">清除草稿</button>
      </div>
      <div class="hint">💾 本页会把你的填写进度保存在浏览器本地（localStorage）。清除浏览器数据会丢失草稿。</div>
    </section>

    <section class="card">
      <h3>YAML 预览</h3>
      <pre id="yaml">（点击“生成胶囊”后在此显示）</pre>
      <div class="btns"><button id="btnCopy">复制 YAML</button></div>
      <h3>人类预览（精要）</h3>
      <pre id="human">（填表后会自动更新为“人类可读版”）</pre>
    </section>
  </main>

  <footer>
    <p>🔒 你的答案仅存浏览器内存；除非你自行上传副本，否则不会离开本地设备。</p>
    <p>📝 异议期：家人/受托人可在 <strong id="gpTxt">30 天</strong> 内联系“紧急联系人”提出修正。更新路径：回到生成器 → 上传旧文件 → 修改 → 重新生成。</p>
    <p>⚠️ 重要提示：本工具生成的内容不具备直接法律效力。请将其视为个人意愿的表达，并咨询法律专业人士以准备具有法律约束力的遗嘱或相关文件。开发者不对因使用此工具而产生的任何后果负责。</p>
  </footer>

<script>
const VERSION = "v3.6";
const DRAFT_KEY = "fireseed_v36_draft";

function sha256Hex(str){
  const enc = new TextEncoder().encode(str);
  return crypto.subtle.digest('SHA-256', enc).then(buf => {
    return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
  });
}
function val(id){ return document.getElementById(id).value.trim(); }
function arrFromTextarea(v){ return v.split(/[\n；;，,、]+/).map(s=>s.replace(/^\d+[\.\)\-]?\s*/,'').trim()).filter(Boolean); }
function toYAML(obj, indent=0){
  const pad = '  '.repeat(indent);
  if (obj === null) return "null";
  if (Array.isArray(obj)) {
    if (obj.length === 0) return "[]";
    return obj.map(x=> pad+"- "+toYAML(x, indent+1).trimStart()).join("\n");
  }
  if (typeof obj === 'object'){
    return Object.keys(obj).map(k=>{
      const v = obj[k];
      if (v === undefined) return null;
      const head = pad + k + ": ";
      if (v && typeof v === 'object' && !Array.isArray(v)){
        return head + "\n" + toYAML(v, indent+1);
      } else if (Array.isArray(v)){
        if (v.length===0) return head+"[]";
        return head + "\n" + toYAML(v, indent+1);
      } else if (typeof v === 'string'){
        if (v.includes(":") || v.includes("#") || v.includes("\"") || v.includes("\n")) {
          return head + '"' + v.replace(/\\"/g,'\\\"') + '"';
        }
        return head + v;
      } else if (typeof v === 'number' || typeof v === 'boolean'){
        return head + String(v);
      } else {
        return head + 'null';
      }
    }).filter(Boolean).join("\n");
  }
  if (typeof obj === 'string') return '"'+obj.replace(/\\"/g,'\\\"')+'"';
  return String(obj);
}
function renderHuman(c){
  const lines = [];
  const owner = c.owner || "anonymous";
  lines.push(`所有者：${owner} · 语言：${c.locale}`);
  if(c.philosophy_refs?.length){ lines.push("", "我思考时的“参考书”：" + c.philosophy_refs.join("、")); }
  if(c.narrative?.story){ lines.push("", c.narrative.story); }
  if(c.principles?.length){ lines.push("", "我的三原则："); c.principles.forEach(x=>lines.push("· "+x)); }
  if(c.non_negotiables?.length){ lines.push("", "我的底线："); c.non_negotiables.forEach(x=>lines.push("· "+x)); }
  if(c.loop){
    const seg = [];
    if(c.loop.trigger) seg.push("感知/触发："+c.loop.trigger);
    if(c.loop.judgment) seg.push("判断："+c.loop.judgment);
    if(c.loop.execute) seg.push("行动："+c.loop.execute);
    if(c.loop.correct) seg.push("反思/纠正："+c.loop.correct);
    if(seg.length) lines.push("", seg.join(" ｜ "));
  }
  if(c.narrative?.ext){
    const e = c.narrative.ext;
    if(e.likes?.length || e.dislikes?.length || e.celebration_dates?.length || e.emergency_contact){
      lines.push("", "——— 生活偏好 ———");
      if(e.likes?.length) lines.push("我喜欢："+e.likes.join("、"));
      if(e.dislikes?.length) lines.push("我讨厌："+e.dislikes.join("、"));
      if(e.celebration_dates?.length) lines.push("重要日期："+e.celebration_dates.join("、"));
      if(e.emergency_contact) lines.push("紧急联系人："+(e.emergency_contact.name||'')+" · "+(e.emergency_contact.contact||''));
    }
  }
  lines.push("", "异议期："+(c.permissions?.grace_period||"P30D"));
  return lines.join("\n");
}
function inferLoop(t){
  t = t.trim();
  if(!t) return {trigger:null, execute:null, correct:null, judgment:null};
  const kv = t.split(/\n+/).filter(Boolean);
  if(kv.every(x=>/^\s*(trigger|execute|correct|judgment)\s*:/i.test(x))){
    const r = {trigger:null, execute:null, correct:null, judgment:null};
    kv.forEach(line=>{ const m=line.match(/^\s*(trigger|execute|correct|judgment)\s*:\s*(.+)$/i); if(m) r[m[1].toLowerCase()] = m[2].trim(); });
    return r;
  }
  const parts = t.split(/→|->|⇒|＞/).map(x=>x.trim()).filter(Boolean);
  if(parts.length >= 2){
    const [p0,p1,p2,p3] = parts;
    return { trigger:p0||null, judgment:p1||null, execute:p2||p1||null, correct:p3||null };
  }
  return {trigger:null, judgment:null, execute:t, correct:null};
}
function computeProgress(){
  let total = 6, done = 0;
  if(val('owner')) done++;
  if(val('philo')) done++;
  if(val('principles')) done++;
  if(val('loop')) done++;
  if(val('nonn')) done++;
  if(val('narrative')) done++;
  const pct = Math.max(16, Math.floor(done/total*100)); // 至少 16%
  document.getElementById('prog').style.width = pct + '%';
}
function saveDraft(){
  const data = {
    owner: val('owner'), locale: val('locale'),
    philo: val('philo'), principles: val('principles'),
    loop: val('loop'), nonn: val('nonn'), narrative: val('narrative'),
    celebrations: val('celebrations'), emergency: val('emergency'),
    likes: val('likes'), dislikes: val('dislikes'),
    access_terms: document.getElementById('access_terms').value,
    access_custom: val('access_custom'),
    passphrase: val('passphrase'),
    allow_derive: document.getElementById('allow_derive').value,
    grace: document.getElementById('grace').value
  };
  localStorage.setItem(DRAFT_KEY, JSON.stringify(data));
}
function loadDraft(){
  try{
    const raw = localStorage.getItem(DRAFT_KEY);
    if(!raw) return;
    const d = JSON.parse(raw);
    for(const [k,v] of Object.entries(d)){
      const el = document.getElementById(k) || document.getElementById(k==='philo'?'philo':k);
      if(!el) continue;
      if(el.tagName==='SELECT') el.value = v || el.value;
      else el.value = v || el.value;
    }
    if(d.access_terms==='custom') document.getElementById('access_custom').style.display='block';
  }catch(e){ console.warn('loadDraft failed', e); }
}
function clearDraft(){
  localStorage.removeItem(DRAFT_KEY);
  alert('已清除本地草稿。');
}

function assembleObject(){
  const loopParsed = inferLoop(val("loop"));
  const ext = (function(){
    const obj = {};
    const cel = val("celebrations");
    const likes = val("likes");
    const dislikes = val("dislikes");
    const em = val("emergency");
    const accSel = document.getElementById("access_terms").value;
    const accCustom = val("access_custom");
    const pwd = val("passphrase");
    if(cel) obj.celebration_dates = cel.split(/[,，；;\s]+/).map(x=>x.trim()).filter(Boolean);
    if(likes) obj.likes = likes.split(/[,，；;\s]+/).map(x=>x.trim()).filter(Boolean);
    if(dislikes) obj.dislikes = dislikes.split(/[,，；;\s]+/).map(x=>x.trim()).filter(Boolean);
    if(em){ const t = em.split(/[,，]+/); obj.emergency_contact = { name:(t[0]||"").trim(), contact:(t.slice(1).join(",")||"").trim() }; }
    if(accSel==='custom' && accCustom) obj.access_terms = accCustom;
    else if(accSel) obj.access_terms = accSel;
    if(pwd) obj.update_passphrase = pwd; // 留空不写
    return obj;
  })();
  const base = {
    version: "capsule_v0",
    format_version: "v3.6",
    owner: (val("owner") || "Lin Tao"),
    locale: document.getElementById("locale").value || "zh-CN",
    philosophy_refs: (function(v){ return v? v.split(/[、,，\n]+/).map(x=>x.trim()).filter(Boolean):[]; })(val("philo")),
    principles: arrFromTextarea(val("principles")),
    non_negotiables: arrFromTextarea(val("nonn")),
    loop: loopParsed,
    permissions: {
      access: ["read", (document.getElementById("allow_derive").value==="yes"?"derive":null)].filter(Boolean),
      grace_period: document.getElementById("grace").value || "P30D"
    },
    storage: { media:["local"], redundancy:1 },
    proofs: { checksum_algo:"SHA-256", hash:null, signature:null, timestamp:new Date().toISOString() },
    narrative: { story: val("narrative"), ext },
    meta: { generated_at: new Date().toISOString(), generator: "fireseed-generator-human-v3.6" }
  };
  return base;
}

async function buildCapsule(){
  // button feedback
  const btn = document.getElementById("btnGen");
  btn.classList.add("loading"); btn.textContent = "生成中…";
  try{
    const base = assembleObject();
    document.getElementById("gpTxt").textContent = (base.permissions.grace_period==="P90D"?"90 天":"30 天");
    // YAML（带注释头）
    let yamlCore = toYAML(base);
    const hash = await sha256Hex(yamlCore);
    base.proofs.hash = hash;
    yamlCore = toYAML(base); // 带 hash 再序列化
    const header = [
      "# Generated by Fireseed Capsule Generator v3.6 on 2025-11-05T20:10:35Z",
      "# This file is client-side only; no data left your device.",
      ""
    ].join("\n");
    const yaml = header + yamlCore;
    // 渲染
    document.getElementById("yaml").textContent = yaml;
    document.getElementById("human").textContent = renderHuman(base);
    window.__capsule_yaml__ = yaml; window.__capsule_hash__ = hash;
    return base;
  } finally {
    setTimeout(()=>{ btn.classList.remove("loading"); btn.textContent = "生成胶囊"; }, 500);
  }
}

document.getElementById("extraBox").addEventListener("toggle", (e)=>{
  document.getElementById("extraSummary").textContent = e.target.open ? "收起 ▼" : "写更多 ▶";
});
document.getElementById("btnGen").addEventListener("click", async ()=>{ await buildCapsule(); });
document.getElementById("btnYAML").addEventListener("click", async ()=>{ await buildCapsule(); const blob = new Blob([window.__capsule_yaml__||""], {type:"text/yaml"}); const a = Object.assign(document.createElement("a"), {href:URL.createObjectURL(blob), download:"capsule_v0.yaml"}); a.click(); setTimeout(()=>URL.revokeObjectURL(a.href), 1000); });
document.getElementById("btnCopy").addEventListener("click", ()=>{ const s = document.getElementById("yaml").textContent || ""; navigator.clipboard.writeText(s); });
document.getElementById("btnSnapshot").addEventListener("click", async ()=>{ await buildCapsule(); const url = "snapshot.html#"+encodeURIComponent(window.__capsule_yaml__||""); window.open(url, "_blank"); });
document.getElementById("btnPDF").addEventListener("click", async ()=>{ await buildCapsule(); const url = "snapshot.html#print#"+encodeURIComponent(window.__capsule_yaml__||""); window.open(url, "_blank"); });

// access terms custom toggle
document.getElementById("access_terms").addEventListener("change", (e)=>{
  document.getElementById("access_custom").style.display = (e.target.value==='custom') ? 'block':'none';
});

// autosave + progress
['owner','locale','philo','principles','loop','nonn','narrative','celebrations','emergency','likes','dislikes','access_terms','access_custom','passphrase','allow_derive','grace']
.forEach(id=>{ const el=document.getElementById(id); if(!el) return; el.addEventListener('input',()=>{ saveDraft(); computeProgress(); }); el.addEventListener('change',()=>{ saveDraft(); computeProgress(); }); });
document.getElementById("btnClear").addEventListener("click", clearDraft);

// init
loadDraft(); computeProgress();
</script>
</body>
</html>
