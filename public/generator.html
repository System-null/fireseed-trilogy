<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Fireseed Capsule Generator Â· å‘å¯¼ç‰ˆ v3.4.2</title>
  <style>
    :root { --fg:#111; --muted:#666; --bg:#fafafa; --pri:#1f6feb; --bd:#e6e6e6; }
    *{box-sizing:border-box} body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;color:var(--fg);background:var(--bg);margin:0}
    header{padding:28px 16px 8px; text-align:center}
    h1{margin:0 0 8px;font-size:22px}
    .sub{color:var(--muted);font-size:13px}
    .wrap{max-width:940px;margin:16px auto;padding:0 16px 64px;display:grid;grid-template-columns:1.2fr 1fr;gap:16px}
    .card{background:#fff;border:1px solid var(--bd);border-radius:14px;padding:16px;box-shadow:0 1px 0 rgba(0,0,0,.03)}
    label{display:block;font-size:13px;color:#444;margin:12px 0 6px}
    input,textarea,select{width:100%;padding:10px 12px;border:1px solid var(--bd);border-radius:10px;background:#fff;font-size:14px}
    textarea{min-height:92px;resize:vertical}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    button{cursor:pointer;border:1px solid var(--bd);background:#fff;border-radius:10px;padding:10px 14px}
    .pri{background:var(--pri);color:#fff;border-color:var(--pri)}
    details{border:1px dashed var(--bd);border-radius:10px;padding:10px;margin-top:10px;background:#fcfcfc}
    summary{cursor:pointer;font-weight:600}
    pre{white-space:pre-wrap;border:1px solid var(--bd);padding:12px;border-radius:10px;background:#0d1117;color:#dfe2e7;font-size:12px;overflow:auto;max-height:60vh}
    .hint{font-size:12px;color:var(--muted)}
    footer{max-width:940px;margin:24px auto 64px;padding:0 16px;color:#777;font-size:12px}
    .badge{display:inline-block;background:#eef6ff;border:1px solid #c9e2ff;color:#0a3d90;font-size:12px;padding:2px 8px;border-radius:999px;margin:0 6px}
    .note{font-size:12px;color:#777;margin:4px 0 8px}
    .tooltip{border-bottom:1px dotted #999; cursor:help;}
  </style>
</head>
<body>
  <header>
    <h1>Fireseed Capsule Generator Â· å‘å¯¼ç‰ˆ v3.4.2 <span class="badge">çº¯å‰ç«¯ Â· é›¶åç«¯ Â· å¯ç¦»çº¿</span></h1>
    <div class="sub">å¡«å®Œç‚¹â€œç”Ÿæˆèƒ¶å›Šâ€å³å¯ä¸‹è½½ <code>capsule_v0.yaml</code>ï¼›è¿˜å¯æ‰“å¼€å¿«ç…§é¡µæ‰“å°æˆ PDFã€‚</div>
  </header>

  <main class="wrap">
    <section class="card" id="form">
      <h3>åŸºæœ¬ä¿¡æ¯</h3>
      <label>æˆ‘æ˜¯è°ï¼ˆOwnerï¼‰</label>
      <input id="owner" placeholder="å¦‚ï¼šLin Tao" value="Lin Tao">

      <label>æˆ‘ç”¨çš„è¯­è¨€ï¼ˆLocaleï¼‰</label>
      <select id="locale">
        <option value="zh-CN">zh-CN</option>
        <option value="en-US">en-US</option>
      </select>

      <label>
        æˆ‘æ€è€ƒæ—¶çš„â€œå‚è€ƒä¹¦â€
        <span class="tooltip" title="å†™ä¸‹æœ€å½±å“ä½ åˆ¤æ–­çš„ä¹¦ã€ç”µå½±ã€äººç‰©æˆ–ä¿¡æ¡ã€‚æœªæ¥ç³»ç»Ÿè¯»åˆ°è¿™äº›ï¼Œæ‰çŸ¥é“ã€ä½ ä»å“ªé‡Œæƒ³é—®é¢˜ã€ã€‚">â“</span>
      </label>
      <input id="philo" placeholder="ä¾‹ï¼šè®ºè¯­ã€åº·å¾·ã€é©¬æ–¯å…‹ã€åœ£ç»ã€é»‘å®¢ä¼¦ç†">

      <div class="note">ğŸ’¬ è¿™ä¸æ˜¯è¯»ä¹¦æ¸…å•ï¼Œè€Œæ˜¯â€œå¦‚æœä½ è¦å¤æ´»æˆ‘ï¼Œè¯·å…ˆè¯»è¿™å‡ æœ¬è¯´æ˜ä¹¦â€ã€‚</div>

      <label>æˆ‘çš„ä¸‰æ¡åŸåˆ™ï¼ˆæ¯è¡Œä¸€ä¸ªï¼‰</label>
      <textarea id="principles" placeholder="ä¾‹ï¼šä»¥æœ€å°èƒ½è€—è¾¾æˆæœ€å¤§ç†è§£"></textarea>

      <label>æˆ‘è¡ŒåŠ¨çš„å¾ªç¯ï¼ˆæ¯è¡Œå½¢å¦‚â€œtrigger: â€¦â€æˆ–â€œexecute: â€¦â€æˆ–â€œcorrect: â€¦â€ï¼‰</label>
      <textarea id="loop" placeholder="trigger: å½“ä»–äººè¯·æ±‚è§£é‡Šç»“æ„æ—¶&#10;execute: ç”¨æœ€å°èƒ½è€—è®²æ¸…æ¥æºä¸è¾¹ç•Œ&#10;correct: è‹¥ä»è¯¯è§£ï¼Œç»™ä¸€æ¬¡å›¾ç¤ºæœºä¼šï¼›å†æ— æ•ˆï¼Œç»ˆæ­¢è§£é‡Š"></textarea>

      <label>æˆ‘çš„åº•çº¿ï¼ˆä¸å¯å¦¥åï¼Œ æ¯è¡Œä¸€ä¸ªï¼‰</label>
      <textarea id="nonn" placeholder="ä¸æ¬ºéª—&#10;ä¸å‰¥å‰Š&#10;ä¸è¿å¿ƒ"></textarea>

      <label>æˆ‘æƒ³ç•™ç»™æœªæ¥çš„ä¸€æ®µè¯ï¼ˆNarrativeï¼Œå¯ç©ºï¼‰</label>
      <textarea id="narrative" placeholder="ç»™æœªæ¥çš„è¯»è€…ï¼šè¿™æ˜¯ä¸€ä»½å…³äºâ€œå¦‚ä½•è¯»å–æˆ‘â€çš„å°å†Œå­ã€‚"></textarea>

      <details id="extraBox">
        <summary id="extraSummary">å†™æ›´å¤š â–¶</summary>
        <div class="note">è¿™äº›å†…å®¹<b>å¯å†™å¯ä¸å†™</b>ï¼Œä¸ä¼šå½±å“ç”Ÿæˆç»“æœã€‚</div>
        <div class="row">
          <div>
            <label>ğŸ‚ æˆ‘åº†ç¥çš„æ—¥å­</label>
            <input id="celebrations" placeholder="04-12, 09-23">
          </div>
          <div>
            <label>ğŸ‘¥ å¦‚æœæˆ‘ä¸åœ¨äº†ï¼Œè¯·è”ç³»ï¼ˆå§“å + é‚®ç®±/å¾®ä¿¡ï¼‰</label>
            <input id="emergency" placeholder="å§“å: ææ˜, å¾®ä¿¡: limom">
          </div>
        </div>
        <div class="row">
          <div>
            <label>â¤ï¸ æˆ‘å–œæ¬¢çš„äº‹ç‰©ï¼ˆé€—å·åˆ†éš”ï¼‰</label>
            <input id="likes" placeholder="çˆµå£«ä¹, ä¹¦åº—, å¤œç©º">
          </div>
          <div>
            <label>ğŸ™… æˆ‘è®¨åŒçš„äº‹ç‰©ï¼ˆé€—å·åˆ†éš”ï¼‰</label>
            <input id="dislikes" placeholder="å™ªéŸ³, æ¬ºéª—">
          </div>
        </div>
        <div class="row">
          <div>
            <label>ğŸ“– æˆ‘æ„¿æ„è¢«è¯»å–çš„æ¡ä»¶</label>
            <select id="access_terms">
              <option value="">æœªå£°æ˜ï¼ˆé»˜è®¤éµå¾ª permissionsï¼‰</option>
              <option value="read_only">ä»…å¯é˜…è¯»ï¼ˆåˆ«äººåªèƒ½çœ‹ï¼‰</option>
              <option value="by_attribution">éœ€ç½²åå¼•ç”¨ï¼ˆè½¬è½½è¦æ ‡ä½ åï¼‰</option>
              <option value="non_commercial">å¯ç”¨äºéå•†ä¸šç ”ç©¶ï¼ˆä¸å¯å–ï¼‰</option>
            </select>
          </div>
          <div>
            <label>ğŸ”‘ æ›´æ–°å¯†ç ï¼ˆ4~6ä½çŸ­è¯­ï¼Œå¯ç©ºï¼‰</label>
            <input id="passphrase" placeholder="seed42">
          </div>
        </div>
      </details>

      <h3 style="margin-top:18px">æƒé™ä¸å­˜å‚¨ï¼ˆå·²é¢„è®¾ï¼Œè‹¥ä¸æ‡‚å¯ä¿æŒé»˜è®¤ï¼‰</h3>
      <div class="row">
        <div>
          <label>æ˜¯å¦å…è®¸æ´¾ç”Ÿï¼ˆderiveï¼‰</label>
          <select id="allow_derive"><option value="yes">æ˜¯</option><option value="no">å¦</option></select>
        </div>
        <div>
          <label>å¼‚è®®æœŸï¼ˆgrace_periodï¼‰</label>
          <select id="grace"><option value="P30D">30 å¤©</option><option value="P90D">90 å¤©</option></select>
        </div>
      </div>

      <div class="btns">
        <button class="pri" id="btnGen">ç”Ÿæˆèƒ¶å›Š</button>
        <button id="btnYAML">ä¸‹è½½ YAML</button>
        <button id="btnPDF">å¯¼å‡º PDF</button>
        <button id="btnSnapshot">æŸ¥çœ‹äººç±»å¿«ç…§</button>
      </div>
      <div class="hint">âš ï¸ çº¯å‰ç«¯ã€æ–­ç½‘å¯ç”¨ï¼›ä¸ä¼šä¸Šä¼ ä½ çš„ä»»ä½•ç­”æ¡ˆã€‚å¤±è´¥æ“ä½œï¼ˆç­¾å/IPFSï¼‰å…è®¸è·³è¿‡ã€‚</div>
    </section>

    <section class="card">
      <h3>YAML é¢„è§ˆ</h3>
      <pre id="yaml">ï¼ˆç‚¹å‡»â€œç”Ÿæˆèƒ¶å›Šâ€ååœ¨æ­¤æ˜¾ç¤ºï¼‰</pre>
      <div class="btns"><button id="btnCopy">å¤åˆ¶ YAML</button></div>
      <h3>äººç±»é¢„è§ˆï¼ˆç²¾è¦ï¼‰</h3>
      <pre id="human">ï¼ˆå¡«è¡¨åä¼šè‡ªåŠ¨æ›´æ–°ä¸ºâ€œäººç±»å¯è¯»ç‰ˆâ€ï¼‰</pre>
    </section>
  </main>

  <footer>
    <p>ğŸ”’ ä½ çš„ç­”æ¡ˆä»…å­˜æµè§ˆå™¨å†…å­˜ï¼›é™¤éä½ è‡ªè¡Œä¸Šä¼ å‰¯æœ¬ï¼Œå¦åˆ™ä¸ä¼šç¦»å¼€æœ¬åœ°è®¾å¤‡ã€‚</p>
    <p>ğŸ“ å¼‚è®®æœŸï¼šå®¶äºº/å—æ‰˜äººå¯åœ¨ <strong id="gpTxt">30 å¤©</strong> å†…è”ç³»â€œç´§æ€¥è”ç³»äººâ€æå‡ºä¿®æ­£ã€‚æ›´æ–°è·¯å¾„ï¼šå›åˆ°ç”Ÿæˆå™¨ â†’ ä¸Šä¼ æ—§æ–‡ä»¶ â†’ ä¿®æ”¹ â†’ é‡æ–°ç”Ÿæˆã€‚</p>
  </footer>

<script>
function sha256Hex(str){
  const enc = new TextEncoder().encode(str);
  return crypto.subtle.digest('SHA-256', enc).then(buf => {
    return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
  });
}
function val(id){ return document.getElementById(id).value.trim(); }
function arrFromTextarea(v){
  return v.split(/\n+/).map(s=>s.trim()).filter(Boolean);
}
function csv(v){ return v.split(/[,ï¼Œ]+/).map(x=>x.trim()).filter(Boolean); }
function splitRefs(v){ return v.split(/[ã€,ï¼Œ\n]+/).map(x=>x.trim()).filter(Boolean); }
function yamlEscape(s){ return s.replace(/\"/g,'\\"'); }

function renderHuman(c){
  const lines = [];
  const owner = c.owner || "anonymous";
  lines.push(`æ‰€æœ‰è€…ï¼š${owner} Â· è¯­è¨€ï¼š${c.locale}`);
  if(c.philosophy_refs?.length){
    lines.push("", "æˆ‘æ€è€ƒæ—¶çš„â€œå‚è€ƒä¹¦â€ï¼š" + c.philosophy_refs.join("ã€"));
  }
  if(c.narrative?.story){ lines.push("", c.narrative.story); }
  if(c.narrative?.ext?.likes?.length){ lines.push("", "æˆ‘å–œæ¬¢ï¼š"+c.narrative.ext.likes.join("ã€")); }
  if(c.narrative?.ext?.dislikes?.length){ lines.push("æˆ‘è®¨åŒï¼š"+c.narrative.ext.dislikes.join("ã€")); }
  if(c.narrative?.ext?.celebration_dates?.length){ lines.push("å¯¹æˆ‘é‡è¦çš„æ—¥å­ï¼š"+c.narrative.ext.celebration_dates.join("ã€")); }
  if(c.narrative?.ext?.emergency_contact){ lines.push("", "ç´§æ€¥è”ç³»äººï¼š"+c.narrative.ext.emergency_contact.name+" Â· "+c.narrative.ext.emergency_contact.contact); }
  lines.push("", "å¼‚è®®æœŸï¼š"+(c.permissions?.grace_period||"P30D"));
  return lines.join("\n");
}

function toYAML(obj, indent=0){
  const pad = '  '.repeat(indent);
  if (obj === null) return "null";
  if (Array.isArray(obj)) {
    if (obj.length === 0) return "[]";
    return obj.map(x=> pad+"- "+toYAML(x, indent+1).trimStart()).join("\n");
  }
  if (typeof obj === 'object'){
    return Object.keys(obj).map(k=>{
      const v = obj[k];
      if (v === undefined) return null;
      const head = pad + k + ": ";
      if (v && typeof v === 'object' && !Array.isArray(v)){
        return head + "\n" + toYAML(v, indent+1);
      } else if (Array.isArray(v)){
        if (v.length===0) return head+"[]";
        return head + "\n" + toYAML(v, indent+1);
      } else if (typeof v === 'string'){
        if (v.includes(":") || v.includes("#") || v.includes("\"") || v.includes("\n")) {
          return head + '"' + yamlEscape(v) + '"';
        }
        return head + v;
      } else if (typeof v === 'number' || typeof v === 'boolean'){
        return head + String(v);
      } else {
        return head + 'null';
      }
    }).filter(Boolean).join("\n");
  }
  if (typeof obj === 'string') return '"'+yamlEscape(obj)+'"';
  return String(obj);
}

async function buildCapsule(){
  const base = {
    version: "capsule_v0",
    format_version: "v0.3.4.2",
    owner: val("owner") || "Lin Tao",
    locale: val("locale") || "zh-CN",
    philosophy_refs: splitRefs(val("philo")),
    principles: arrFromTextarea(val("principles")),
    non_negotiables: arrFromTextarea(val("nonn")),
    loop: { trigger: null, execute: null, correct: null },
    permissions: {
      access: ["read", (val("allow_derive")==="yes"?"derive":null)].filter(Boolean),
      grace_period: val("grace") || "P30D"
    },
    storage: { media:["local"], redundancy:1 },
    proofs: { checksum_algo:"SHA-256", hash:null, signature:null, timestamp:new Date().toISOString() },
    meta: { generated_at: new Date().toISOString(), generator: "fireseed-generator-human-v3.4.2" }
  };
  const lines = arrFromTextarea(val("loop"));
  lines.forEach(line=>{
    const m = line.match(/^\s*(trigger|execute|correct)\s*:\s*(.+)$/i);
    if(m){ base.loop[m[1].toLowerCase()] = m[2]; }
  });
  // narrative ext
  const ext = {};
  if(val("celebrations")) ext.celebration_dates = csv(val("celebrations"));
  if(val("likes")) ext.likes = csv(val("likes"));
  if(val("dislikes")) ext.dislikes = csv(val("dislikes"));
  if(val("emergency")){
    const t = val("emergency").split(/[,ï¼Œ]+/);
    ext.emergency_contact = { name: (t[0]||"").trim(), contact: (t.slice(1).join(",")||"").trim() };
  }
  if(val("access_terms")) ext.access_terms = val("access_terms");
  if(val("passphrase")) ext.update_passphrase = val("passphrase"); // ç•™ç©ºåˆ™çœç•¥
  base.narrative = { story: val("narrative")||"", ext };

  // grace text
  document.getElementById("gpTxt").textContent = (base.permissions.grace_period==="P90D"?"90 å¤©":"30 å¤©");

  // preliminary YAML (without hash)
  let yaml = toYAML(base);
  const hash = await sha256Hex(yaml);
  base.proofs.hash = hash;

  // é‡æ–°åºåˆ—åŒ–ï¼ˆåŒ…å« hashï¼‰
  yaml = toYAML(base);

  // æ¸²æŸ“
  document.getElementById("yaml").textContent = yaml;
  document.getElementById("human").textContent = renderHuman(base);

  // ä¾›ä¸‹è½½/å¿«ç…§ä½¿ç”¨
  window.__capsule_yaml__ = yaml;
  window.__capsule_hash__ = hash;
  return base;
}

document.getElementById("extraBox").addEventListener("toggle", (e)=>{
  const sum = document.getElementById("extraSummary");
  sum.textContent = e.target.open ? "æ”¶èµ· â–¼" : "å†™æ›´å¤š â–¶";
});

document.getElementById("btnGen").addEventListener("click", buildCapsule);
document.getElementById("btnYAML").addEventListener("click", async ()=>{
  await buildCapsule();
  const blob = new Blob([window.__capsule_yaml__||""], {type:"text/yaml"});
  const a = Object.assign(document.createElement("a"), {href:URL.createObjectURL(blob), download:"capsule_v0.yaml"});
  a.click(); setTimeout(()=>URL.revokeObjectURL(a.href), 1000);
});
document.getElementById("btnCopy").addEventListener("click", ()=>{
  const s = document.getElementById("yaml").textContent || "";
  navigator.clipboard.writeText(s);
});
document.getElementById("btnSnapshot").addEventListener("click", async ()=>{
  await buildCapsule();
  const url = "snapshot.html#"+encodeURIComponent(window.__capsule_yaml__||"");
  window.open(url, "_blank");
});
document.getElementById("btnPDF").addEventListener("click", async ()=>{
  await buildCapsule();
  const url = "snapshot.html#print#"+encodeURIComponent(window.__capsule_yaml__||"");
  window.open(url, "_blank");
});
</script>
</body>
</html>
